FROM golang:1.16 as builder1
COPY . /iot-management
WORKDIR /iot-management
ARG GIT_SUMMARY
RUN CGO_ENABLED=1 GOOS=linux go build -a -o /go/bin/management -ldflags='-extldflags "-static" -X github.com/everactive/dmscore/iot-management/versions.Version='"$GIT_SUMMARY" bin/management/management.go
RUN CGO_ENABLED=1 GOOS=linux go build -a -o /go/bin/createsuperuser -ldflags='-extldflags "-static" -X github.com/everactive/dmscore/iot-management/versions.Version='"$GIT_SUMMARY" cmd/createsuperuser/main.go


FROM node:8-alpine as builder2
COPY webapp .
WORKDIR /
RUN npm install
RUN npm rebuild node-sass
RUN npm run build

# Set params from the environment variables
ARG DRIVER="postgres"
ARG DATASOURCE="dbname=management sslmode=disable"
ARG HOST="management:8010"
ARG SCHEME="http"
ARG DEVICETWINAPI="http://devicetwin:8040/v1/"
ARG STOREURL="https://api.snapcraft.io/api/v1/"
ENV DRIVER="${DRIVER}"
ENV DATASOURCE="${DATASOURCE}"
ENV HOST="${HOST}"
ENV SCHEME="${SCHEME}"
ENV DEVICETWINAPI="${DEVICETWINAPI}"
ENV STOREURL="${STOREURL}"

# Copy the built applications to the docker image
FROM ubuntu:18.04
WORKDIR /root/
RUN apt-get update
RUN apt-get install -y ca-certificates
COPY --from=builder1 /go/bin/management .
COPY --from=builder1 /go/bin/createsuperuser .
COPY --from=builder1 /iot-management/static ./static
COPY --from=builder2 build/static/css ./static/css
COPY --from=builder2 build/static/js ./static/js
COPY --from=builder2 build/index.html ./static/app.html
EXPOSE 8010
ENTRYPOINT /root/management run
CMD ['./createsuperuser']
